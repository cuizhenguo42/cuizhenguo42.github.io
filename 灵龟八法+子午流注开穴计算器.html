预览
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>灵龟八法+子午流注 开穴计算</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Microsoft YaHei", 微软雅黑, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
            font-size: 16px;
        }
        .result-area {
            min-height: 100px;
            padding: 8px 12px; /* 减小内边距，上下8px、左右12px */
            background-color: #fff;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-top: 10px;
            white-space: pre-wrap;
            line-height: 1.4; /* 核心：行距从1.8降到1.4，更紧凑 */
        }
        /* ========== 核心修改1：统一滚动容器样式，避免嵌套 ========== */
        /* 只保留一个滚动容器类，删除嵌套 */
        .table-scroll-container {
            overflow-x: auto;
            overflow-y: auto;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            max-height: 600px !important;
            /* 关键：为sticky提供正确的定位容器 */
            position: relative;
        }
        /* 兼容原有类名，避免修改HTML */
        .table-area, .table-responsive {
            overflow-x: auto;
            overflow-y: auto;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            max-height: 600px !important;
            position: relative;
        }
        .btn-group-vertical > .btn {
            margin-bottom: 5px;
        }
        .text-red {
            color: #dc3545;
        }
        .text-blue {
            color: #0d6efd;
        }
        .text-purple {
            color: #6f42c1;
        }
        .text-orange {
            color: #fd7e14;
        }
        .fw-bold {
            font-weight: bold;
        }
        .btn-outline-purple.btn-active {
            background-color: #6f42c1 !important;
            color: white !important;
            border-color: #6f42c1 !important;
        }
        .btn-outline-orange.btn-active {
            background-color: #fd7e14 !important;
            color: white !important;
            border-color: #fd7e14 !important;
        }
        /* ========== 核心修改2：表格样式修复 ========== */
        .table-bordered {
            border: 1px solid #dee2e6 !important;
            /* 关键：改为collapse，解决sticky兼容性问题 */
            border-collapse: collapse !important;
            border-spacing: 0;
            border-radius: 8px;
            /* 移除overflow: hidden，避免遮挡sticky表头 */
        }
        .table td, .table th {
            padding: 6px 8px !important;
            font-size: 14px !important;
            line-height: 1.3 !important;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: center;
            border-color: #dee2e6 !important;
        }
        .table tbody td {
            background-color: #ffffff !important;
            color: #4a5568 !important;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f8f9fa !important;
        }
        .table tbody tr:hover {
            background-color: #f0f8fb !important;
            cursor: default;
        }
        /* ========== 核心修改3：表头冻结样式强化 ========== */
        /* 通用表头冻结（最高优先级，覆盖bootstrap的table-dark） */
        .table thead th {
            position: sticky !important;
            top: 0 !important;
            z-index: 999 !important; /* 大幅提高z-index，避免被覆盖 */
            background-color: #e8f4f8 !important;
            color: #2d3748 !important;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6 !important;
            /* 防止文字被遮挡 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* 子午流注双层表头 - 顶层表头 */
        .table thead tr:first-child th {
            top: 0 !important;
            background-color: #2c3e50 !important;
            color: white !important;
            padding: 10px 8px !important;
            border-bottom: 1px solid #dee2e6 !important;
            z-index: 1000 !important; /* 比子表头高 */
        }
        /* 子午流注双层表头 - 子表头（动态匹配顶层高度） */
        .table thead tr:nth-child(2) th {
            top: 42px !important; /* 匹配顶层表头实际渲染高度 */
            background-color: #7c4dff !important;
            color: white !important;
            padding: 8px 8px !important;
            z-index: 998 !important;
        }
        /* 纳子法子表头颜色 */
        .table thead tr:nth-child(2) th[colspan="7"] {
            background-color: #fd9843 !important;
        }
        /* 修复table-dark覆盖问题 */
        .table-dark thead th {
            position: sticky !important;
            top: 0 !important;
            z-index: 999 !important;
        }
        /* 避免表体第一行被覆盖 */
        .table tbody tr:first-child td {
            border-top: 2px solid #dee2e6 !important;
        }
        /* 标题样式 */
        .text-purple.mb-3 {
            color: #2c7a7b !important;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h2 class="text-purple fw-bold">灵龟八法 + 子午流注 开穴计算</h2>
                <p class="text-muted">基于传统针灸时间疗法规则 | 支持全天12时辰批量开穴 | 作者：蓝天白云</p>
            </div>
        </div>

        <!-- 基础参数输入区 -->
        <div class="card">
            <div class="card-header bg-primary text-white">基础参数设置</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">自定义时间</label>
                        <div class="d-flex gap-2"> <!-- 弹性布局，输入框和按钮并排 -->
                            <input type="datetime-local" id="customDatetime" class="form-control flex-grow-1" step="60">
                        </div>
                        <div class="form-text text-danger">选择完成后点击屏幕空白处，或按回车键</div> <!-- text-danger 是专门用于设置红色文本的类 -->
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">性别（灵龟八法专用）</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="male" checked value="男">
                                <label class="form-check-label" for="male">男</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="female" value="女">
                                <label class="form-check-label" for="female">女</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">当地经度（°E）</label>
                        <input type="number" id="longitude" class="form-control" value="120.0" min="73" max="135" step="0.1">
                        <div class="form-text">经度：故城116,北京116.40，上海121.48</div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">全天计算日期</label>
                        <input type="date" id="batchDate" class="form-control" value="">
                    </div>
                </div>
            </div>
        </div>

        <!-- 功能按钮区 -->
        <div class="row g-3">
            <!-- 灵龟八法按钮 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-purple text-white" style="background-color: #6f42c1 !important;">灵龟八法 功能按钮</div>
                    <div class="card-body d-flex flex-wrap gap-2">
                        <button id="lgCurrentBtn" class="btn btn-outline-purple btn-sm" style="border-color: #6f42c1; color: #6f42c1;">当前时间开穴</button>
                        <button id="lgCustomBtn" class="btn btn-outline-purple btn-sm" style="border-color: #6f42c1; color: #6f42c1;">自定义时间开穴</button>
                        <button id="lgBatchBtn" class="btn btn-outline-purple btn-sm" style="border-color: #6f42c1; color: #6f42c1;">全天12时辰批量开穴</button>
                        <button id="lgClearBtn" class="btn btn-danger btn-sm">清空结果</button>
                    </div>
                </div>
            </div>
            <!-- 子午流注按钮 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-orange text-white" style="background-color: #fd7e14 !important;">子午流注 功能按钮</div>
                    <div class="card-body d-flex flex-wrap gap-2">
                        <button id="zwCurrentBtn" class="btn btn-outline-orange btn-sm" style="border-color: #fd7e14; color: #fd7e14;">当前时间开穴</button>
                        <button id="zwCustomBtn" class="btn btn-outline-orange btn-sm" style="border-color: #fd7e14; color: #fd7e14;">自定义时间开穴</button>
                        <button id="zwBatchBtn" class="btn btn-outline-orange btn-sm" style="border-color: #fd7e14; color: #fd7e14;">全天12时辰批量开穴</button>
                        <button id="zwClearBtn" class="btn btn-danger btn-sm">清空结果</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果展示区 -->
        <div class="row g-3">
            <!-- 灵龟八法结果 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-purple text-white" style="background-color: #6f42c1 !important;">灵龟八法 开穴结果</div>
                    <div class="card-body">
                        <div id="lingguiResult" class="result-area">请点击上方功能按钮进行计算...</div>
                    </div>
                </div>
            </div>
            <!-- 子午流注结果 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-orange text-white" style="background-color: #fd7e14 !important;">子午流注 开穴结果（纳甲+纳子法）</div>
                    <div class="card-body">
                        <div id="zwlcResult" class="result-area">请点击上方功能按钮进行计算...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 全天批量表格结果区 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">全天12时辰批量开穴表格</div>
                    <div class="card-body">
                        <!-- 核心修改：使用统一的滚动容器类 -->
                        <div id="batchTableResult" class="table-scroll-container">批量计算结果将显示在此处...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ===================== 全局常量定义（完全对应VBA原版，补充原穴治证）=====================
        const STANDARD_TIAN_GAN = "甲乙丙丁戊己庚辛壬癸";
        const STANDARD_DI_ZHI = "子丑寅卯辰巳午未申酉戌亥";
        // ========== 新增全局变量：记录按钮动作类型 ==========
        let lingguiActionType = ""; // 灵龟八法动作类型（当前时间开穴/自定义时间开穴）
        let zwlcActionType = "";   // 子午流注动作类型（当前时间开穴/自定义时间开穴）
        // ===================================================

        // 灵龟八法常量
        const YANG_RI_GAN = ["甲", "丙", "戊", "庚", "壬"];
        const YIN_RI_GAN = ["乙", "丁", "己", "辛", "癸"];
        const SHI_CHEN_FULL_CONFIG = [
            ["子时", 23, 1, 23, 30], ["丑时", 1, 3, 2, 0],
            ["寅时", 3, 5, 4, 0], ["卯时", 5, 7, 6, 0],
            ["辰时", 7, 9, 8, 0], ["巳时", 9, 11, 10, 0],
            ["午时", 11, 13, 12, 0], ["未时", 13, 15, 14, 0],
            ["申时", 15, 17, 16, 0], ["酉时", 17, 19, 18, 0],
            ["戌时", 19, 21, 20, 0], ["亥时", 21, 23, 22, 0]
        ];
        const RI_GAN_ZHI_NUM = {
            10: { "甲": true, "己": true, "辰": true, "丑": true, "戌": true, "未": true },
            9: { "乙": true, "庚": true, "申": true, "酉": true },
            8: { "丁": true, "壬": true, "寅": true, "卯": true },
            7: { "戊": true, "癸": true, "丙": true, "辛": true, "巳": true, "午": true, "亥": true, "子": true }
        };
        const SHI_GAN_ZHI_NUM = {
            9: { "甲": true, "己": true, "子": true, "午": true },
            8: { "乙": true, "庚": true, "丑": true, "未": true },
            7: { "丙": true, "辛": true, "寅": true, "申": true },
            6: { "丁": true, "壬": true, "卯": true, "酉": true },
            5: { "戊": true, "癸": true, "辰": true, "戌": true },
            4: { "巳": true, "亥": true }
        };
        const NUM_TO_POINT = {
            1: ["申脉", "通阳跷脉", "后溪"], 2: ["照海", "通阴跷脉", "列缺"],
            3: ["外关", "通阳维脉", "足临泣"], 4: ["足临泣", "通带脉", "外关"],
            5: ["照海", "通阴跷脉", "列缺"], 6: ["公孙", "通冲脉", "内关"],
            7: ["后溪", "通督脉", "申脉"], 8: ["内关", "通阴维脉", "公孙"],
            9: ["列缺", "通任脉", "照海"]
        };
        const JIAO_JING_PAIR = {
            "公孙": "内关", "内关": "公孙", "照海": "列缺", "列缺": "照海",
            "外关": "足临泣", "足临泣": "外关", "后溪": "申脉", "申脉": "后溪"
        };
        const GUEST_CHANNEL_DICT = {
            "后溪": "通督脉", "列缺": "通任脉", "外关": "通阳维脉", "公孙": "通冲脉",
            "申脉": "通阳跷脉", "足临泣": "通带脉", "内关": "通阴维脉", "照海": "通阴跷脉"
        };
        const POINT_DETAIL_ENHANCED = {
            "公孙": [
                "足太阴脾经",
                "足内侧第1跖骨基底前下方，赤白肉际处",
                "【主冶】胃痛（寒痛/虚痛/气滞痛）、胃胀、嗳气、反酸、呕吐、腹胀、腹泻、痢疾、便秘；月经不调、痛经、崩漏、带下；心悸、胸闷、失眠、焦虑、晕车晕船",
                "【次治】疝气、脚气、水肿、黄疸、食欲不振、小儿疳积",
                "【病机】脾失健运、气血瘀滞、冲脉失调、胃失和降",
                "【配伍建议】配内关治冠心病/胃痛；配足三里治脾虚腹泻；配太冲治痛经"
            ],
            "内关": [
                "手厥阴心包经",
                "腕横纹上2寸，掌长肌腱与桡侧腕屈肌腱之间",
                "【主冶】心痛、胸闷、心悸、心律失常、冠心病、心绞痛；失眠、多梦、健忘、焦虑、抑郁、癫狂；胃痛、呕吐、呃逆、晕车；中风、偏瘫、失语、手臂麻木",
                "【次治】偏头痛、眩晕、热病、中暑、产后血晕",
                "【病机】心包经气郁滞、心脉痹阻、胃气上逆、心神不宁",
                "【配伍建议】配公孙治胃食管反流；配神门治失眠；配膻中治胸闷"
            ],
            "照海": [
                "足少阴肾经",
                "内踝尖下1寸，内踝下缘边际凹陷中",
                "【主冶】咽喉肿痛、咽干、失音、梅核气；失眠、多梦、嗜睡、癫痫、癔症；月经不调、痛经、闭经、阴痒、带下、疝气；小便频数、癃闭、水肿",
                "【次治】便秘、泄泻、脚气、下肢痿痹、足跟痛",
                "【病机】肾阴不足、虚火上炎、阴跷脉失养、下焦湿热",
                "【配伍建议】配列缺治咽喉肿痛；配神门治失眠；配三阴交治月经不调"
            ],
            "列缺": [
                "手太阴肺经",
                "腕横纹上1.5寸，桡骨茎突上方，肱桡肌与拇长展肌腱之间",
                "【主冶】咳嗽（风寒/风热/阴虚）、气喘、咯血、咽喉肿痛；头痛（偏头痛/后头痛）、项强、落枕、颈椎病；面瘫、面痛、牙痛、鼻出血",
                "【次治】手腕痛、手指麻木、小便失禁、遗尿",
                "【病机】肺失宣降、经络阻滞、任脉失调",
                "【配伍建议】配照海治咽炎；配风池治头痛；配合谷治牙痛"
            ],
            "外关": [
                "手少阳三焦经",
                "腕背横纹上2寸，尺骨与桡骨间隙中点",
                "【主冶】偏头痛、眩晕、耳鸣、耳聋、中耳炎；咽喉肿痛、颊肿、目赤肿痛；肩背痛、肘臂屈伸不利、手指麻木；感冒、发热、外感热病",
                "【次治】胁痛、腹胀、便秘、瘰疬、腮腺炎",
                "【病机】三焦经气不畅、风热外袭、经络痹阻",
                "【配伍建议】配足临泣治偏头痛；配曲池治发热；配肩髃治肩痛"
            ],
            "足临泣": [
                "足少阳胆经",
                "足背第4、5跖骨底结合部前方，第5趾长伸肌腱外侧凹陷中",
                "【主冶】偏头痛、胁肋痛、乳痛、月经不调、痛经；目赤肿痛、视物昏花、耳鸣、耳聋；足背肿痛、下肢痿痹、脚气；瘰疬、疟疾",
                "【次治】失眠、多梦、烦躁、口苦、黄疸",
                "【病机】胆经郁热、带脉失调、经络不通",
                "【配伍建议】配外关治偏头痛；配太冲治胁痛；配乳根治乳痛"
            ],
            "后溪": [
                "手太阳小肠经",
                "第5掌指关节尺侧近端，掌横纹头赤白肉际处",
                "【主冶】颈项强痛、颈椎病、落枕、肩背痛；腰腿痛、急性腰扭伤、坐骨神经痛；失眠、多梦、癫痫、癔症；手指麻木、屈伸不利、腕痛",
                "【次治】目赤肿痛、耳鸣、耳聋、鼻出血、疟疾",
                "【病机】督脉不通、小肠经气阻滞、筋脉失养",
                "【配伍建议】配申脉治颈腰痛；配神门治失眠；配委中治腰扭伤"
            ],
            "申脉": [
                "足太阳膀胱经",
                "外踝尖下1寸，外踝下缘边际凹陷中",
                "【主冶】失眠（不寐/易醒）、嗜睡、癫痫、眩晕；头痛（后头痛/偏头痛）、项强、落枕；腰腿痛、下肢痿痹、足跟痛、脚气；小便不利、癃闭",
                "【次治】呕吐、泄泻、腹胀、发热、感冒",
                "【病机】阳跷脉失养、膀胱经气不畅、髓海不足",
                "【配伍建议】配后溪治颈腰痛；配百会治眩晕；配涌泉治失眠"
            ]
        };
        const POINT_COMBINATION_TREATMENT = {
            "公孙-内关": "【冠心病】心悸、胸闷、胸痛、气短；【脾胃病】胃痛（寒/热/虚/实）、胃胀、反酸、呕吐、腹泻；【妇科病】月经不调、痛经、崩漏、更年期综合征；【神志病】焦虑、抑郁、失眠、晕车晕船",
            "照海-列缺": "【呼吸道病】感冒、咳嗽（风寒/风热）、咽喉肿痛、咽干失音、梅核气；【神志病】失眠、多梦、癫痫、癔症；【下焦病】月经不调、阴痒、小便频数",
            "外关-足临泣": "【头面病】偏头痛、眩晕、耳鸣、耳聋、目赤肿痛；【经络病】胁痛、肩背痛、肘臂痛、足背肿痛；【杂病】瘰疬、疟疾、口苦、烦躁",
            "后溪-申脉": "【颈肩腰病】颈椎病、落枕、肩背痛、急性腰扭伤、坐骨神经痛、足跟痛；【神志病】失眠、多梦、癫痫、癔症；【五官病】目赤肿痛、耳鸣、鼻出血"
        };

        // 子午流注常量（核心修正：补充原穴治证）
        const ZWLC_RI_GAN_RULE = {
            "甲": ["胆经", "窍阴(井金)", "戌时", "阳日", "三焦经", "液门(荥水)", "他生我（水生木）"],
            "丙": ["小肠经", "少泽(井金)", "申时", "阳日", "三焦经", "中渚(输木)", "他生我（木生火）"],
            "戊": ["胃经", "厉兑(井金)", "午时", "阳日", "三焦经", "支沟(经火)", "他生我（火生土）"],
            "庚": ["大肠经", "商阳(井金)", "辰时", "阳日", "三焦经", "天井(合土)", "他生我（土生金）"],
            "壬": ["膀胱经", "至阴(井金)", "寅时", "阳日", "三焦经", "关冲(井金)", "他生我（金生水）"],
            "乙": ["肝经", "大敦(井木)", "酉时", "阴日", "心包经", "劳宫(荥火)", "我生他（木生火）"],
            "丁": ["心经", "少冲(井木)", "未时", "阴日", "心包经", "大陵(输土)", "我生他（火生土）"],
            "己": ["脾经", "隐白(井木)", "巳时", "阴日", "心包经", "间使(经金)", "我生他（土生金）"],
            "辛": ["肺经", "少商(井木)", "卯时", "阴日", "心包经", "曲泽(合水)", "我生他（金生水）"],
            "癸": ["肾经", "涌泉(井木)", "亥时", "阴日", "心包经", "中冲(井木)", "我生他（水生木）"]
        };
        const ZWLC_SHICHEN_JINGMAI = {
            "子时": "胆经", "丑时": "肝经", "寅时": "肺经", "卯时": "大肠经",
            "辰时": "胃经", "巳时": "脾经", "午时": "心经", "未时": "小肠经",
            "申时": "膀胱经", "酉时": "肾经", "戌时": "心包经", "亥时": "三焦经"
        };
        const ZWLC_JINGMAI_WUXING = {
            "肺经": "金", "大肠经": "金", "胃经": "土", "脾经": "土",
            "心经": "火", "小肠经": "火", "膀胱经": "水", "肾经": "水",
            "心包经": "火", "三焦经": "火", "胆经": "木", "肝经": "木"
        };
        // 核心优化：补充每个经脉原穴的详细治证（第6项）
        const ZWLC_JINGMAI_XUEWEI = {
            "肺经": [
                "太渊(母)", "尺泽(子)", "太渊(原)",
                "【母穴治证】肺气虚（咳嗽无力、气短懒言、自汗、易感冒）、肺阴虚（干咳少痰、咽干、盗汗）、心悸、脉结代、手腕痛",
                "【子穴治证】肺热（咳嗽黄痰、咽喉肿痛、胸痛、咯血）、胃热、肘臂痛、小儿惊风、吐泻",
                "【原穴治证】咳嗽、气喘、咯血、胸痛、咽喉肿痛、腕臂痛、无脉症、心悸、失眠、健忘、肩背痛"
            ],
            "大肠经": [
                "曲池(母)", "二间(子)", "合谷(原)",
                "【母穴治证】大肠气虚（便秘、腹泻、腹痛喜按）、上肢痿痹、湿疹、荨麻疹、发热、高血压",
                "【子穴治证】大肠实热（便秘、腹痛拒按、牙痛、咽喉肿痛、目赤）、口干、手指麻木",
                "【原穴治证】头痛、目赤肿痛、鼻衄、齿痛、咽喉肿痛、口眼歪斜、耳聋、痄腮、热病无汗、多汗、经闭、滞产、腹痛、便秘、痢疾、瘾疹、半身不遂"
            ],
            "胃经": [
                "解溪(母)", "厉兑(子)", "冲阳(原)",
                "【母穴治证】胃气虚（胃痛喜按、纳差、嗳气、腹胀）、下肢痿痹、足背肿痛、头痛、眩晕",
                "【子穴治证】胃实热（胃痛拒按、口臭、便秘、牙痛、鼻衄）、多梦、癫狂、足背肿痛",
                "【原穴治证】胃痛、腹胀、纳呆、呕吐、泄泻、痢疾、足背肿痛、下肢痿痹、面肿、口眼歪斜、癫狂、胃痛发作期急救"
            ],
            "脾经": [
                "大都(母)", "商丘(子)", "太白(原)",
                "【母穴治证】脾气虚（腹胀、便溏、食欲不振、乏力、水肿）、小儿疳积、足趾痛",
                "【子穴治证】脾经实热（便秘、黄疸、腹胀拒按、咽喉肿痛、足内踝痛）、疟疾",
                "【原穴治证】胃痛、腹胀、肠鸣、泄泻、便秘、痢疾、体重节痛、脚气、消化不良、小儿疳积、月经不调、崩漏"
            ],
            "心经": [
                "少冲(母)", "神门(子)", "神门(原)",
                "【母穴治证】心气虚（心悸、气短、失眠、多梦、健忘）、舌强不语、手指麻木、热病",
                "【子穴治证】心实热（心烦、失眠、口舌生疮、癫狂、胸痛、掌中热）",
                "【原穴治证】心痛、心悸、怔忡、失眠、健忘、痴呆、癫狂痫、高血压、胸胁痛、掌中热、腕痛"
            ],
            "小肠经": [
                "后溪(母)", "小海(子)", "腕骨(原)",
                "【母穴治证】小肠虚寒（腹痛、腹泻、肠鸣、遗尿、颈肩痛）、失眠、癫痫、手指麻木",
                "【子穴治证】小肠实热（咽痛、耳聋、耳鸣、肘臂痛、癫痫、颊肿）",
                "【原穴治证】指挛腕痛、头项强痛、目翳、耳鸣、耳聋、热病无汗、黄疸、消渴、疟疾、癫痫、腰背痛"
            ],
            "膀胱经": [
                "至阴(母)", "束骨(子)", "京骨(原)",
                "【母穴治证】膀胱虚寒（尿频、尿急、遗尿、腰痛喜按、头痛）、胎位不正、难产",
                "【子穴治证】膀胱实热（尿痛、尿急、血尿、腰痛拒按、头痛、项强）、癫痫、足趾痛",
                "【原穴治证】头痛、眩晕、项强、腰腿痛、下肢痿痹、癫痫、目赤肿痛、鼻出血、小便不利、遗尿"
            ],
            "肾经": [
                "复溜(母)", "涌泉(子)", "太溪(原)",
                "【母穴治证】肾阴虚（腰酸、耳鸣、盗汗、便秘、水肿）、月经不调、下肢痿痹、足跟痛",
                "【子穴治证】肾实热（咽痛、口舌生疮、心烦、失眠、小便不利、小儿惊风）",
                "【原穴治证】头痛、眩晕、耳鸣、耳聋、失眠、健忘、遗精、阳痿、月经不调、痛经、闭经、小便频数、便秘、腰脊痛、下肢厥冷、足跟痛"
            ],
            "心包经": [
                "中冲(母)", "大陵(子)", "大陵(原)",
                "【母穴治证】心包气虚（胸闷、心悸、气短、失眠、多梦）、中风、中暑、舌强不语",
                "【子穴治证】心包实热（心烦、癫狂、口臭、胸痛、腕痛、掌中热）",
                "【原穴治证】心痛、心悸、胃痛、呕吐、口臭、癫狂痫、胸胁痛、腕关节疼痛、掌中热、失眠、抑郁"
            ],
            "三焦经": [
                "关冲(母)", "天井(子)", "阳池(原)",
                "【母穴治证】三焦虚寒（腹胀、水肿、小便不利、耳鸣、耳聋）、头痛、目赤、手指麻木",
                "【子穴治证】三焦实热（胁痛、耳鸣、耳聋、瘰疬、肘臂痛、癫痫）",
                "【原穴治证】腕痛、肩臂痛、目赤肿痛、耳聋、耳鸣、疟疾、消渴、感冒、发热、腕关节扭伤"
            ],
            "胆经": [
                "侠溪(母)", "阳辅(子)", "丘墟(原)",
                "【母穴治证】胆气虚（胁痛喜按、头晕、口苦、失眠、易惊）、耳鸣、耳聋、足背肿痛",
                "【子穴治证】胆实热（偏头痛、胁痛拒按、口苦、黄疸、癫痫、下肢痿痹）",
                "【原穴治证】偏头痛、目赤肿痛、目生翳膜、耳鸣、耳聋、颈项强痛、腋下肿、胸胁痛、下肢痿痹、外踝肿痛、疟疾"
            ],
            "肝经": [
                "曲泉(母)", "行间(子)", "太冲(原)",
                "【母穴治证】肝阴虚（胁痛、头晕、目眩、月经不调、膝痛）、小便不利、疝气",
                "【子穴治证】肝实热（头痛、目赤、口苦、胁痛、痛经、小儿惊风、癫痫）",
                "【原穴治证】头痛、眩晕、目赤肿痛、口苦、咽干、胁痛、疝气、崩漏、月经不调、痛经、经闭、癫痫、小儿惊风、中风、下肢痿痹、足背肿痛"
            ]
        };
        const ZWLC_XUEWEI_DETAIL = {
            "甲日戌时": ["窍阴", "胆经", "井穴(金)", "【主冶】偏头痛、目赤肿痛、耳鸣耳聋、咽喉肿痛、足跗肿痛、热病、昏迷", "无原穴（井穴阶段）"],
            "甲日子时": ["前谷", "小肠经", "荥穴(水)", "【主冶】头痛、目痛、耳鸣、咽喉肿痛、乳少、热病、手指麻木、肘臂挛痛", "无原穴（荥穴阶段）"],
            "甲日寅时": ["陷谷", "胃经", "输穴(木)", "【主冶】面肿、目赤肿痛、肠鸣、腹痛、热病、足背肿痛", "返本还原：丘墟（胆经原穴）"],
            "甲日辰时": ["阳溪", "大肠经", "经穴(火)", "【主冶】头痛、目赤肿痛、耳聋、耳鸣、齿痛、咽喉肿痛、腕痛、臂痛", "无原穴（经穴阶段）"],
            "甲日午时": ["委中", "膀胱经", "合穴(土)", "【主冶】腰背痛、急性腰扭伤、坐骨神经痛、下肢痿痹、小便不利、腹痛、吐泻", "无原穴（合穴阶段）"],
            "甲日申时": ["液门", "三焦经", "荥穴(水)", "【主冶】头痛、目赤肿痛、耳鸣、耳聋、咽喉肿痛、手臂痛、手指麻木、热病", "气纳三焦（他生我：水生木）"],
            "乙日酉时": ["大敦", "肝经", "井穴(木)", "【主冶】疝气、少腹痛、遗尿、癃闭、月经不调、崩漏、阴挺、癫痫、善寐", "无原穴（井穴阶段）"],
            "乙日亥时": ["少府", "心经", "荥穴(火)", "【主冶】心悸、胸痛、小便不利、遗尿、阴痒、小指挛痛、掌中热", "无原穴（荥穴阶段）"],
            "乙日丑时": ["太白", "脾经", "输穴(土)", "【主冶】胃痛、腹胀、肠鸣、泄泻、便秘、痢疾、体重节痛、脚气", "返本还原：太冲（肝经输穴代原）"],
            "乙日卯时": ["经渠", "肺经", "经穴(金)", "【主冶】咳嗽、气喘、咯血、咽喉肿痛、腕痛、掌中热", "无原穴（经穴阶段）"],
            "乙日巳时": ["阴谷", "肾经", "合穴(水)", "【主冶】阳痿、遗精、月经不调、崩漏、小便不利、膝痛、癫狂", "无原穴（合穴阶段）"],
            "乙日未时": ["劳宫", "心包经", "荥穴(火)", "【主冶】心痛、心悸、癫狂、痫证、口疮、口臭、掌中热、呕吐、中风", "血归包络（我生他：木生火）"],
            "丙日申时": ["少泽", "小肠经", "井穴(金)", "【主冶】头痛、目翳、咽喉肿痛、乳痈、乳汁少、昏迷、热病、手指麻木", "无原穴（井穴阶段）"],
            "丙日戌时": ["内庭", "胃经", "荥穴(水)", "【主冶】齿痛、咽喉肿痛、口歪、鼻衄、腹胀、泄泻、痢疾、热病、足背肿痛", "无原穴（荥穴阶段）"],
            "丙日子时": ["三间", "大肠经", "输穴(木)", "【主冶】齿痛、咽喉肿痛、目痛、腹胀、肠鸣、泄泻、手背肿痛", "返本还原：腕骨（小肠经原穴）"],
            "丙日寅时": ["昆仑", "膀胱经", "经穴(火)", "【主冶】头痛、项强、眩晕、癫痫、中风偏瘫、腰背痛、足跟痛、下肢痿痹", "无原穴（经穴阶段）"],
            "丙日辰时": ["阳陵泉", "胆经", "合穴(土)", "【主冶】胁痛、口苦、呕吐、黄疸、下肢痿痹、脚气、小儿惊风、肩痛", "无原穴（合穴阶段）"],
            "丙日午时": ["中渚", "三焦经", "输穴(木)", "【主冶】头痛、目赤肿痛、耳鸣、耳聋、咽喉肿痛、肩背肘臂酸痛、手指屈伸不利", "气纳三焦（他生我：木生火）"],
            "丁日未时": ["少冲", "心经", "井穴(木)", "【主冶】心悸、心痛、胸胁痛、癫狂、热病、昏迷、小儿惊风", "无原穴（井穴阶段）"],
            "丁日酉时": ["大都", "脾经", "荥穴(火)", "【主冶】腹胀、胃痛、呕吐、泄泻、便秘、热病无汗、体重肢肿、足跗肿痛", "无原穴（荥穴阶段）"],
            "丁日亥时": ["太渊", "肺经", "输穴(土)", "【主冶】咳嗽、气喘、咯血、胸痛、咽喉肿痛、腕臂痛、无脉症", "返本还原：神门（心经输穴代原）"],
            "丁日丑时": ["复溜", "肾经", "经穴(金)", "【主冶】水肿、腹胀、泄泻、盗汗、热病汗不出、下肢痿痹、腰脊强痛", "无原穴（经穴阶段）"],
            "丁日卯时": ["曲泉", "肝经", "合穴(水)", "【主冶】月经不调、痛经、带下、阴挺、阴痒、产后腹痛、遗精、阳痿、疝气、小便不利", "无原穴（合穴阶段）"],
            "丁日巳时": ["大陵", "心包经", "输穴(土)", "【主冶】心痛、心悸、胃痛、呕吐、癫狂、痫证、胸胁胀痛、腕关节疼痛", "血归包络（我生他：火生土）"],
            "戊日午时": ["厉兑", "胃经", "井穴(金)", "【主冶】鼻衄、齿痛、咽喉肿痛、腹胀、热病、多梦、癫狂", "无原穴（井穴阶段）"],
            "戊日申时": ["二间", "大肠经", "荥穴(水)", "【主冶】目赤肿痛、鼻衄、齿痛、咽喉肿痛、口歪、热病、手背肿痛", "无原穴（荥穴阶段）"],
            "戊日戌时": ["束骨", "膀胱经", "输穴(木)", "【主冶】头痛、项强、腰腿痛、急性腰扭伤、坐骨神经痛、目赤肿痛、癫痫", "返本还原：冲阳（胃经原穴）"],
            "戊日子时": ["阳辅", "胆经", "经穴(火)", "【主冶】偏头痛、目外眦痛、缺盆中痛、腋下痛、瘰疬、胸胁胀痛、下肢痿痹、脚气", "无原穴（经穴阶段）"],
            "戊日寅时": ["小海", "小肠经", "合穴(土)", "【主冶】肘臂疼痛、麻木、癫痫", "无原穴（合穴阶段）"],
            "戊日辰时": ["支沟", "三焦经", "经穴(火)", "【主冶】胁肋痛、便秘、耳鸣、耳聋、暴喑、瘰疬、热病、肩臂痛", "气纳三焦（他生我：火生土）"],
            "己日巳时": ["隐白", "脾经", "井穴(木)", "【主冶】月经过多、崩漏、便血、尿血、癫狂、多梦、惊风、腹胀", "无原穴（井穴阶段）"],
            "己日未时": ["鱼际", "肺经", "荥穴(火)", "【主冶】咳嗽、咯血、咽喉肿痛、失音、发热、掌中热", "无原穴（荥穴阶段）"],
            "己日酉时": ["太溪", "肾经", "输穴(土)", "【主冶】头痛、眩晕、耳鸣、耳聋、失眠、健忘、遗精、阳痿、月经不调、腰痛", "返本还原：太白（脾经输穴代原）"],
            "己日亥时": ["中封", "肝经", "经穴(金)", "【主冶】疝气、少腹痛、遗精、小便不利、腰痛、足冷、内踝肿痛", "无原穴（经穴阶段）"],
            "己日丑时": ["少海", "心经", "合穴(水)", "【主冶】心痛、肘臂挛痛、麻木、癫痫、瘰疬", "无原穴（合穴阶段）"],
            "己日卯时": ["间使", "心包经", "经穴(金)", "【主冶】心痛、心悸、胃痛、呕吐、热病、疟疾、癫狂、肘臂挛痛", "血归包络（我生他：土生金）"],
            "庚日辰时": ["商阳", "大肠经", "井穴(金)", "【主冶】齿痛、咽喉肿痛、目赤、耳聋、热病、昏迷、手指麻木", "无原穴（井穴阶段）"],
            "庚日午时": ["通谷", "膀胱经", "荥穴(水)", "【主冶】头痛、目眩、腰腿痛、下肢痿痹、小便不利、癃闭、水肿、疟疾", "无原穴（荥穴阶段）"],
            "庚日申时": ["足临泣", "胆经", "输穴(木)", "【主冶】偏头痛、胁肋痛、乳痛、月经不调、目赤肿痛、足背肿痛、下肢痿痹、瘰疬", "返本还原：合谷（大肠经原穴）"],
            "庚日戌时": ["阳谷", "小肠经", "经穴(火)", "【主冶】头痛、目眩、耳鸣、耳聋、咽喉肿痛、热病、癫狂、腕痛、臂痛", "无原穴（经穴阶段）"],
            "庚日子时": ["足三里", "胃经", "合穴(土)", "【主冶】胃痛、呕吐、噎膈、腹胀、泄泻、便秘、痢疾、乳痈、下肢痿痹、癫狂", "无原穴（合穴阶段）"],
            "庚日寅时": ["天井", "三焦经", "合穴(土)", "【主冶】偏头痛、胁肋痛、颈项肩臂痛、瘰疬、癫痫", "气纳三焦（他生我：土生金）"],
            "辛日卯时": ["少商", "肺经", "井穴(木)", "【主冶】咽喉肿痛、咳嗽、气喘、咯血、鼻衄、热病、昏迷、癫狂", "无原穴（井穴阶段）"],
            "辛日巳时": ["然谷", "肾经", "荥穴(火)", "【主冶】月经不调、带下、阴痒、遗精、阳痿、小便不利、泄泻、消渴、足跗肿痛", "无原穴（荥穴阶段）"],
            "辛日未时": ["太冲", "肝经", "输穴(土)", "【主冶】头痛、眩晕、目赤肿痛、口苦、胁痛、疝气、崩漏、月经不调、癫痫、小儿惊风", "返本还原：太渊（肺经输穴代原）"],
            "辛日酉时": ["灵道", "心经", "经穴(金)", "【主冶】心痛、暴喑、肘臂挛痛、手指麻木、失眠", "无原穴（经穴阶段）"],
            "辛日亥时": ["阴陵泉", "脾经", "合穴(水)", "【主冶】腹胀、泄泻、水肿、黄疸、小便不利、遗尿、痛经、阴痒、膝痛", "无原穴（合穴阶段）"],
            "辛日丑时": ["曲泽", "心包经", "合穴(水)", "【主冶】心痛、心悸、胃痛、呕吐、泄泻、热病、肘臂挛痛", "血归包络（我生他：金生水）"],
            "壬日寅时": ["至阴", "膀胱经", "井穴(金)", "【主冶】头痛、目痛、鼻塞、鼻衄、胎位不正、难产、胞衣不下、足跗肿痛", "无原穴（井穴阶段）"],
            "壬日辰时": ["侠溪", "胆经", "荥穴(水)", "【主冶】头痛、眩晕、耳鸣耳聋、目赤肿痛、胁肋疼痛、膝股痛、足跗肿痛、疟疾、热病", "无原穴（荥穴阶段）"],
            "壬日午时": ["后溪", "小肠经", "输穴(木)", "【主冶】头项强痛、腰背痛、手指及肘臂挛痛、耳聋、目赤、癫狂痫、疟疾", "返本还原：京骨（膀胱经原穴）"],
            "壬日申时": ["解溪", "胃经", "经穴(火)", "【主冶】头痛、眩晕、癫狂、腹胀、便秘、下肢痿痹、足踝肿痛", "无原穴（经穴阶段）"],
            "壬日戌时": ["曲池", "大肠经", "合穴(土)", "【主冶】手臂肿痛、上肢不遂、热病、高血压、癫狂、腹痛、吐泻、痢疾、瘾疹", "无原穴（合穴阶段）"],
            "壬日子时": ["关冲", "三焦经", "井穴(金)", "【主冶】头痛、目赤、耳鸣、耳聋、喉痹、舌强、热病、中暑", "气纳三焦（他生我：金生水）"],
            "癸日亥时": ["涌泉", "肾经", "井穴(木)", "【主冶】头痛、头晕、目眩、失眠、昏厥、癫狂、小儿惊风、小便不利、便秘", "无原穴（井穴阶段，特殊起时）"],
            "癸日丑时": ["行间", "肝经", "荥穴(火)", "【主冶】头痛、目赤肿痛、青盲、口歪、胁痛、疝气、小便不利、崩漏、癫痫、月经不调", "无原穴（荥穴阶段）"],
            "癸日卯时": ["神门", "心经", "输穴(土)", "【主冶】心痛、心烦、惊悸、怔忡、健忘、失眠、癫狂痫、胸胁痛", "返本还原：太溪（肾经原穴）+ 大陵（心包经原穴）"],
            "癸日巳时": ["商丘", "脾经", "经穴(金)", "【主冶】腹胀、肠鸣、泄泻、便秘、黄疸、足踝肿痛", "无原穴（经穴阶段）"],
            "癸日未时": ["尺泽", "肺经", "合穴(水)", "【主冶】咳嗽、气喘、咯血、咽喉肿痛、肘臂挛痛、急性吐泻、中暑、小儿惊风", "无原穴（合穴阶段）"],
            "癸日酉时": ["中冲", "心包经", "井穴(木)", "【主冶】中风昏迷、舌强不语、中暑、昏厥、小儿惊风、热病、舌下肿痛", "血归包络（我生他：水生木）"]
        };

        // 页面加载时初始化日期
        window.onload = function() {
            // ========== 核心修改：修复时区偏移，确保默认显示本地当前时间 ==========
            const today = new Date();
            
            // 1. 处理自定义时间（datetime-local）- 格式：YYYY-MM-DDTHH:MM
            // 手动拼接本地时间字符串，避免ISO格式的时区偏移
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // 月份从0开始，补0
            const day = String(today.getDate()).padStart(2, '0'); // 日期补0
            const hours = String(today.getHours()).padStart(2, '0'); // 小时补0
            const minutes = String(today.getMinutes()).padStart(2, '0'); // 分钟补0
            const localDatetime = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById("customDatetime").value = localDatetime;
            
            // 2. 处理全天计算日期（date）- 格式：YYYY-MM-DD
            const localDate = `${year}-${month}-${day}`;
            document.getElementById("batchDate").value = localDate;
            
            // 绑定按钮事件
            bindButtonEvents();
        };

        // ===================== 核心辅助函数（通用，优化原穴治证查询）=====================
        function CalculateTrueSolarTime(beijingTime, longitude) {
            try {
                const minutes = (longitude - 120) * 4;
                return new Date(beijingTime.getTime() + minutes * 60 * 1000);
            } catch (e) {
                console.error("真太阳时计算错误：", e);
                return beijingTime;
            }
        }

        function GetRiGanZhi(inputDate) {
            try {
                const baseDate = new Date(2025, 11, 20); // 2025-12-20 基准日
                const ganIdxBase = 9; // 基准日天干：癸
                const zhiIdxBase = 11; // 基准日地支：亥
                const dayDiff = Math.floor((inputDate.getTime() - baseDate.getTime()) / (24 * 60 * 60 * 1000));
                let riGanIdx = (ganIdxBase + dayDiff) % 10;
                let riZhiIdx = (zhiIdxBase + dayDiff) % 12;
                if (riGanIdx < 0) riGanIdx += 10;
                if (riZhiIdx < 0) riZhiIdx += 12;
                const riGan = STANDARD_TIAN_GAN.charAt(riGanIdx);
                const riZhi = STANDARD_DI_ZHI.charAt(riZhiIdx);
                return [riGan, riZhi, riGan + riZhi];
            } catch (e) {
                console.error("日干支计算错误：", e);
                return ["未知", "未知", "未知"];
            }
        }

        function GetShiGanZhi(riGan, trueSolarTime) {
            try {
                let shiChenName = "未知时辰", shiZhi = "未知", shiStart = 0, shiEnd = 0;
                let shiGan = "未知";
                if (!riGan || !(trueSolarTime instanceof Date)) {
                    return [shiGan, shiZhi, shiGan + shiZhi, shiChenName, shiStart, shiEnd];
                }
                const wuShuDunMap = {
                    "甲": 0, "己": 0, "乙": 2, "庚": 2,
                    "丙": 4, "辛": 4, "丁": 6, "壬": 6,
                    "戊": 8, "癸": 8
                };
                const intHour = trueSolarTime.getHours();
                const intMinute = trueSolarTime.getMinutes();
                const totalHour = intHour + intMinute / 60;
                for (let i = 0; i < SHI_CHEN_FULL_CONFIG.length; i++) {
                    shiChenName = SHI_CHEN_FULL_CONFIG[i][0];
                    shiStart = SHI_CHEN_FULL_CONFIG[i][1];
                    shiEnd = SHI_CHEN_FULL_CONFIG[i][2];
                    if ((shiStart <= totalHour && totalHour < shiEnd) || 
                        (shiStart === 23 && totalHour >= 23) || (shiEnd === 1 && totalHour < 1)) {
                        shiZhi = STANDARD_DI_ZHI.charAt(i);
                        break;
                    }
                }
                if (wuShuDunMap.hasOwnProperty(riGan)) {
                    const startIdx = wuShuDunMap[riGan];
                    const zhiIndex = STANDARD_DI_ZHI.indexOf(shiZhi);
                    let shiGanIdx = (startIdx + zhiIndex) % 10;
                    if (shiGanIdx >= 0 && shiGanIdx < 10) {
                        shiGan = STANDARD_TIAN_GAN.charAt(shiGanIdx);
                    }
                }
                return [shiGan, shiZhi, shiGan + shiZhi, shiChenName, shiStart, shiEnd];
            } catch (e) {
                console.error("时干支计算错误：", e);
                return ["未知", "未知", "未知", "未知时辰", 0, 0];
            }
        }

        function GetGanZhiNum(ganZhiChar, numMap) {
            try {
                for (const num in numMap) {
                    if (numMap[num].hasOwnProperty(ganZhiChar)) {
                        return parseInt(num);
                    }
                }
                return 0;
            } catch (e) {
                console.error("干支数值转换错误：", e);
                return 0;
            }
        }

        function GetSeasonWuXing(inputDate, jingmai) {
            return ZWLC_JINGMAI_WUXING[jingmai] || "";
        }

        function GetZiMuXueByWuXing(jingmai, wuXing) {
            let muXue = "未知", ziXue = "未知", yuanXue = "未知";
            if (!ZWLC_JINGMAI_XUEWEI.hasOwnProperty(jingmai)) {
                return { muXue, ziXue, yuanXue };
            }
            if (jingmai !== "三焦经" && jingmai !== "心包经") {
                muXue = ZWLC_JINGMAI_XUEWEI[jingmai][0];
                ziXue = ZWLC_JINGMAI_XUEWEI[jingmai][1];
                yuanXue = ZWLC_JINGMAI_XUEWEI[jingmai][2];
            } else {
                yuanXue = ZWLC_JINGMAI_XUEWEI[jingmai][2];
                if (wuXing === "水") {
                    muXue = jingmai === "三焦经" ? "关冲(母)" : "中冲(母)";
                    ziXue = jingmai === "三焦经" ? "天井(子)" : "大陵(子)";
                } else {
                    muXue = ZWLC_JINGMAI_XUEWEI[jingmai][0];
                    ziXue = ZWLC_JINGMAI_XUEWEI[jingmai][1];
                }
            }
            return { muXue, ziXue, yuanXue };
        }

        function GetShengJing(currentJingMai, riGan) {
            try {
                const currentWuXing = ZWLC_JINGMAI_WUXING[currentJingMai] || "";
                const shengWuXingMap = { "木": "火", "火": "土", "土": "金", "金": "水", "水": "木" };
                const shengWuXing = shengWuXingMap[currentWuXing] || currentWuXing;
                const isYangRi = "甲丙戊庚壬".includes(riGan);
                const yangJing = ["胆经", "小肠经", "胃经", "大肠经", "膀胱经", "三焦经"];
                const yinJing = ["肝经", "心经", "脾经", "肺经", "肾经", "心包经"];
                const jingList = isYangRi ? yangJing : yinJing;
                for (const jing of jingList) {
                    if (ZWLC_JINGMAI_WUXING[jing] === shengWuXing) {
                        return jing;
                    }
                }
                return currentJingMai;
            } catch (e) {
                console.error("经生经计算错误：", e);
                return currentJingMai;
            }
        }

        function GetShengXue(currentXueWei, currentWuXing, xueWeiType) {
            try {
                const shengWuXingMap = { "木": "火", "火": "土", "土": "金", "金": "水", "水": "木" };
                const shengWuXing = shengWuXingMap[currentWuXing] || currentWuXing;
                const nextXueTypeMap = {
                    "井穴": "荥穴", "荥穴": "输穴", "输穴": "经穴",
                    "经穴": "合穴", "合穴": "井穴"
                };
                const nextXueType = nextXueTypeMap[xueWeiType] || xueWeiType;
                const jingmai = GetXueWeiJingMai(currentXueWei);
                if (!jingmai) return "无";
                for (const key in ZWLC_XUEWEI_DETAIL) {
                    const xueInfo = ZWLC_XUEWEI_DETAIL[key];
                    if (xueInfo && Array.isArray(xueInfo) && xueInfo.length >= 3 && xueInfo[1] === jingmai && xueInfo[2] === `${nextXueType}(${shengWuXing})`) {
                        return xueInfo[0];
                    }
                }
                return "无";
            } catch (e) {
                console.error("穴生穴计算错误：", e);
                return "无";
            }
        }

        function GetHeRiHuYongXue(riGan, shiChen) {
            try {
                const heRiMap = {
                    "甲": "己", "己": "甲", "乙": "庚", "庚": "乙",
                    "丙": "辛", "辛": "丙", "丁": "壬", "壬": "丁",
                    "戊": "癸", "癸": "戊"
                };
                if (!heRiMap.hasOwnProperty(riGan)) return "无";
                const heRi = heRiMap[riGan];
                const key = `${heRi}日${shiChen}`;
                if (ZWLC_XUEWEI_DETAIL.hasOwnProperty(key)) {
                    const xueInfo = ZWLC_XUEWEI_DETAIL[key];
                    if (xueInfo && Array.isArray(xueInfo) && xueInfo.length >= 2) {
                        return `${heRi}日${shiChen}：${xueInfo[0]}（${xueInfo[1]}）`;
                    }
                }
                return "无";
            } catch (e) {
                console.error("合日互用计算错误：", e);
                return "无";
            }
        }

        function GetXueWeiJingMai(xueWeiName) {
            try {
                for (const key in ZWLC_XUEWEI_DETAIL) {
                    const xueInfo = ZWLC_XUEWEI_DETAIL[key];
                    if (xueInfo && Array.isArray(xueInfo) && xueInfo.length >= 1 && xueInfo[0] === xueWeiName) {
                        return xueInfo[1];
                    }
                }
                for (const jingmai in ZWLC_JINGMAI_XUEWEI) {
                    const xueList = ZWLC_JINGMAI_XUEWEI[jingmai];
                    if (xueList[0].includes(xueWeiName) || xueList[1].includes(xueWeiName) || xueList[2].includes(xueWeiName)) {
                        return jingmai;
                    }
                }
                return "未知经脉";
            } catch (e) {
                console.error("穴位经脉查询错误：", e);
                return "未知经脉";
            }
        }

        // 核心优化：支持原穴治证查询
        function GetXueWeiZhuZhi(xueWeiName) {
            try {
                // 优先查纳甲法穴位治证
                for (const key in ZWLC_XUEWEI_DETAIL) {
                    const xueInfo = ZWLC_XUEWEI_DETAIL[key];
                    if (xueInfo && Array.isArray(xueInfo) && xueInfo.length >= 1 && xueInfo[0] === xueWeiName) {
                        return xueInfo[3];
                    }
                }
                // 查灵龟八法穴位治证
                if (POINT_DETAIL_ENHANCED.hasOwnProperty(xueWeiName)) {
                    return `${POINT_DETAIL_ENHANCED[xueWeiName][2]}\n${POINT_DETAIL_ENHANCED[xueWeiName][3]}`;
                }
                // 查原穴治证
                for (const jingmai in ZWLC_JINGMAI_XUEWEI) {
                    const xueList = ZWLC_JINGMAI_XUEWEI[jingmai];
                    // 提取原穴名称（去掉括号）
                    const yuanXueName = xueList[2].split("(")[0];
                    if (yuanXueName === xueWeiName && xueList.length >= 6) {
                        return xueList[5]; // 返回原穴治证
                    }
                    // 查母穴/子穴治证
                    const muXueName = xueList[0].split("(")[0];
                    const ziXueName = xueList[1].split("(")[0];
                    if (muXueName === xueWeiName) {
                        return xueList[3]; // 母穴治证
                    }
                    if (ziXueName === xueWeiName) {
                        return xueList[4]; // 子穴治证
                    }
                }
                return "暂无详细主治信息";
            } catch (e) {
                console.error("穴位主治查询错误：", e);
                return "暂无详细主治信息";
            }
        }

        function formatTime(date) {
            try {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (e) {
                console.error("时间格式化错误：", e);
                return "未知时间";
            }
        }

        // ===================== 灵龟八法核心功能 =====================

         // 补全灵龟八法核心函数剩余部分
        function LingGuiBaFaCore(inputDateTime, gender, longitude) {
            const result = {};
            try {
                const trueSolarTime = CalculateTrueSolarTime(inputDateTime, longitude);
                const riGanZhiInfo = GetRiGanZhi(trueSolarTime);
                const riGan = riGanZhiInfo[0];
                const riZhi = riGanZhiInfo[1];
                const shiGanZhiInfo = GetShiGanZhi(riGan, trueSolarTime);
                const riGanDs = GetGanZhiNum(riGan, RI_GAN_ZHI_NUM);
                const riZhiDs = GetGanZhiNum(riZhi, RI_GAN_ZHI_NUM);
                const shiGanDs = GetGanZhiNum(shiGanZhiInfo[0], SHI_GAN_ZHI_NUM);
                const shiZhiDs = GetGanZhiNum(shiGanZhiInfo[1], SHI_GAN_ZHI_NUM);
                const totalDs = riGanDs + riZhiDs + shiGanDs + shiZhiDs;
                const isYangRi = YANG_RI_GAN.includes(riGan);
                const riType = isYangRi ? "阳日" : "阴日";
                let remainder = isYangRi ? totalDs % 9 : totalDs % 6;
                remainder = remainder === 0 ? (isYangRi ? 9 : 6) : remainder;
                let mainPoint, mainChannel, guestPoint, guestChannel;
                if (remainder === 5) {
                    if (gender === "男") {
                        mainPoint = "照海";
                        mainChannel = "通阴跷脉";
                        guestPoint = JIAO_JING_PAIR[mainPoint];
                        guestChannel = "通任脉";
                    } else {
                        mainPoint = "内关";
                        mainChannel = "通阴维脉";
                        guestPoint = "公孙";
                        guestChannel = "通冲脉";
                    }
                } else {
                    const pointInfo = NUM_TO_POINT[remainder];
                    if (pointInfo && pointInfo.length >= 3) {
                        mainPoint = pointInfo[0];
                        mainChannel = pointInfo[1];
                        guestPoint = pointInfo[2];
                        guestChannel = GUEST_CHANNEL_DICT[guestPoint];
                    } else {
                        mainPoint = "未知";
                        mainChannel = "未知";
                        guestPoint = "未知";
                        guestChannel = "未知";
                    }
                }
                result["原始北京时间"] = formatTime(inputDateTime);
                result["真太阳时"] = formatTime(trueSolarTime);
                result["当地经度"] = longitude;
                result["日干支"] = riGanZhiInfo[2];
                result["时干支"] = shiGanZhiInfo[2];
                result["时辰"] = shiGanZhiInfo[3];
                result["余数"] = remainder;
                result["日类型"] = riType;
                result["性别"] = gender;
                result["主穴"] = `${mainPoint}-${mainChannel}`;
                result["配穴"] = `${guestPoint}-${guestChannel}`;
                result["下针顺序"] = `先针${mainPoint}，后针${guestPoint}`;
                if (POINT_DETAIL_ENHANCED.hasOwnProperty(mainPoint)) {
                    const mpInfo = POINT_DETAIL_ENHANCED[mainPoint];
                    result["主穴经脉归属"] = mpInfo[0];
                    result["主穴位置"] = mpInfo[1];
                    result["主穴详细治证"] = `${mpInfo[2]}\n${mpInfo[3]}\n${mpInfo[4]}\n${mpInfo[5]}`;
                }
                if (POINT_DETAIL_ENHANCED.hasOwnProperty(guestPoint)) {
                    const gpInfo = POINT_DETAIL_ENHANCED[guestPoint];
                    result["配穴经脉归属"] = gpInfo[0];
                    result["配穴位置"] = gpInfo[1];
                    result["配穴详细治证"] = `${gpInfo[2]}\n${gpInfo[3]}\n${gpInfo[4]}\n${gpInfo[5]}`;
                }
                // 补充配穴组合治证
                const pairKey = `${mainPoint}-${guestPoint}`;
                const reversePairKey = `${guestPoint}-${mainPoint}`;
                if (POINT_COMBINATION_TREATMENT.hasOwnProperty(pairKey)) {
                    result["穴位组合主治"] = POINT_COMBINATION_TREATMENT[pairKey];
                } else if (POINT_COMBINATION_TREATMENT.hasOwnProperty(reversePairKey)) {
                    result["穴位组合主治"] = POINT_COMBINATION_TREATMENT[reversePairKey];
                } else {
                    result["穴位组合主治"] = "暂无组合治证信息";
                }
                result["计算状态"] = "成功";
            } catch (e) {
                console.error("灵龟八法计算错误：", e);
                result["计算状态"] = "失败";
                result["错误信息"] = e.message;
            }
            return result;
        }

        // ===================== 子午流注核心功能（纳甲+纳子法）=====================
        function ZwLiuZhuCore(inputDateTime, longitude) {
            const result = {};
            try {
                const trueSolarTime = CalculateTrueSolarTime(inputDateTime, longitude);
                const riGanZhiInfo = GetRiGanZhi(trueSolarTime);
                const riGan = riGanZhiInfo[0];
                const riZhi = riGanZhiInfo[1];
                const shiGanZhiInfo = GetShiGanZhi(riGan, trueSolarTime);
                const shiChen = shiGanZhiInfo[3];
                const shiZhi = shiGanZhiInfo[1];
                
                // 纳甲法计算
                let najiaResult = {};
                if (ZWLC_RI_GAN_RULE.hasOwnProperty(riGan)) {
                    const riGanRule = ZWLC_RI_GAN_RULE[riGan];
                    const mainJing = riGanRule[0];
                    const mainXue = riGanRule[1];
                    const mainShi = riGanRule[2];
                    const riType = riGanRule[3];
                    const fuZhuJing = riGanRule[4];
                    const fuZhuXue = riGanRule[5];
                    const shengKeRule = riGanRule[6];
                    
                    najiaResult["本日开经"] = mainJing;
                    najiaResult["本日井穴"] = mainXue;
                    najiaResult["井穴对应时辰"] = mainShi;
                    najiaResult["日属性"] = riType;
                    najiaResult["纳甲配经"] = fuZhuJing;
                    najiaResult["纳甲配穴"] = fuZhuXue;
                    najiaResult["生克规则"] = shengKeRule;
                    
                    // 查找当前时辰纳甲开穴
                    const timeKey = `${riGan}日${shiChen}`;
                    if (ZWLC_XUEWEI_DETAIL.hasOwnProperty(timeKey)) {
                        const xueInfo = ZWLC_XUEWEI_DETAIL[timeKey];
                        najiaResult["当前时辰纳甲开穴"] = xueInfo[0];
                        najiaResult["开穴经脉"] = xueInfo[1];
                        najiaResult["穴位类型"] = xueInfo[2];
                        najiaResult["开穴主治"] = xueInfo[3];
                        najiaResult["特殊说明"] = xueInfo[4];
                        // 补充穴位治证
                        najiaResult["详细治证"] = GetXueWeiZhuZhi(xueInfo[0]);
                    } else {
                        najiaResult["当前时辰纳甲开穴"] = "无专属开穴";
                        najiaResult["合日互用开穴"] = GetHeRiHuYongXue(riGan, shiChen);
                    }
                } else {
                    najiaResult["计算状态"] = "无对应日干规则";
                }
                
                // 纳子法计算
                let naziResult = {};
                const shiChenJing = ZWLC_SHICHEN_JINGMAI[shiChen];
                naziResult["当前时辰当令经脉"] = shiChenJing;
                if (ZWLC_JINGMAI_XUEWEI.hasOwnProperty(shiChenJing)) {
                    const jingXueInfo = ZWLC_JINGMAI_XUEWEI[shiChenJing];
                    const wuXing = GetSeasonWuXing(trueSolarTime, shiChenJing);
                    const muZiXue = GetZiMuXueByWuXing(shiChenJing, wuXing);
                    
                    naziResult["当令经母穴"] = muZiXue.muXue;
                    naziResult["当令经子穴"] = muZiXue.ziXue;
                    naziResult["当令经原穴"] = muZiXue.yuanXue;
                    naziResult["母穴治证"] = GetXueWeiZhuZhi(muZiXue.muXue.split("(")[0]);
                    naziResult["子穴治证"] = GetXueWeiZhuZhi(muZiXue.ziXue.split("(")[0]);
                    naziResult["原穴治证"] = GetXueWeiZhuZhi(muZiXue.yuanXue.split("(")[0]);
                } else {
                    naziResult["当令经母穴"] = "未知";
                    naziResult["当令经子穴"] = "未知";
                    naziResult["当令经原穴"] = "未知";
                }

                // 整合结果
                result["原始北京时间"] = formatTime(inputDateTime);
                result["真太阳时"] = formatTime(trueSolarTime);
                result["当地经度"] = longitude;
                result["日干支"] = riGanZhiInfo[2];
                result["时干支"] = shiGanZhiInfo[2];
                result["时辰"] = shiChen;
                result["纳甲法结果"] = najiaResult;
                result["纳子法结果"] = naziResult;
                result["计算状态"] = "成功";
            } catch (e) {
                console.error("子午流注计算错误：", e);
                result["计算状态"] = "失败";
                result["错误信息"] = e.message;
            }
            return result;
        }

        // ===================== 结果展示函数 =====================
        function showLingGuiResult(result) {
            const resultEl = document.getElementById("lingguiResult");
            if (result["计算状态"] === "失败") {
                resultEl.innerHTML = `计算失败：${result["错误信息"]}`;
                return;
            }
            let html = `
<span style="color: #d9534f; font-weight: bold;">【基础信息】</span>
操作类型：${lingguiActionType || "未知操作"}<! ========== 新增：显示按钮对应文字 ==========!>
北京时间：${result["原始北京时间"]}
真太阳时：${result["真太阳时"]}
当地经度：${result["当地经度"]}°E
日干支：${result["日干支"]} | 时干支：${result["时干支"]} | 时辰：${result["时辰"]}
日类型：${result["日类型"]} | 性别：${result["性别"]} | 计算余数：${result["余数"]}
<span style="color: #d9534f; font-weight: bold;">【开穴结果】</span>
主穴：${result["主穴"]}
配穴：${result["配穴"]}
下针顺序：${result["下针顺序"]}
<span style="color: #d9534f; font-weight: bold;">【主穴详情】</span>
经脉归属：${result["主穴经脉归属"] || "未知"}
位置：${result["主穴位置"] || "未知"}
详细治证：
${result["主穴详细治证"] || "暂无"}
<span style="color: #d9534f; font-weight: bold;">【配穴详情】</span>
经脉归属：${result["配穴经脉归属"] || "未知"}
位置：${result["配穴位置"] || "未知"}
详细治证：
${result["配穴详细治证"] || "暂无"}
<span style="color: #d9534f; font-weight: bold;">【组合治证】</span>
${result["穴位组合主治"] || "暂无"}
            `;
            resultEl.innerHTML = html;
        }
function showZwlcResult(result) {
    const resultEl = document.getElementById("zwlcResult");
    if (result["计算状态"] === "失败") {
        resultEl.innerHTML = `计算失败：${result["错误信息"]}`;
        return;
    }
    const najia = result["纳甲法结果"];
    const nazi = result["纳子法结果"];          
    // ========== 修改1：精简纳甲法结果的换行 ==========
    let najiaHtml = `
<span style="color: #d9534f; font-weight: bold;">【纳甲法开穴】</span>
本日开经：${najia["本日开经"] || "未知"}
本日井穴：${najia["本日井穴"] || "未知"}（对应时辰：${najia["井穴对应时辰"] || "未知"}）
日属性：${najia["日属性"] || "未知"} | 生克规则：${najia["生克规则"] || "未知"}
纳甲配经：${najia["纳甲配经"] || "未知"} | 纳甲配穴：${najia["纳甲配穴"] || "未知"}
当前时辰开穴：${najia["当前时辰纳甲开穴"] || "无"}
${najia["合日互用开穴"] ? `合日互用：${najia["合日互用开穴"]}` : ""}
开穴经脉：${najia["开穴经脉"] || "未知"}
穴位类型：${najia["穴位类型"] || "未知"}
特殊说明：${najia["特殊说明"] || "无"}
开穴治证：${najia["详细治证"] || "暂无"} <!-- 去掉“开穴治证:”后面的单独换行 -->
    `;
    // ========== 修改2：精简纳子法结果的换行 ==========
    let naziHtml = `
<span style="color: #d9534f; font-weight: bold;">【纳子法开穴】</span>
当前时辰当令经脉：${nazi["当前时辰当令经脉"] || "未知"}
母穴：${nazi["当令经母穴"] || "未知"}
子穴：${nazi["当令经子穴"] || "未知"}
原穴：${nazi["当令经原穴"] || "未知"}
【母穴治证】${nazi["母穴治证"] || "暂无"} <!-- 去掉“【母穴治证】”后面的单独换行 -->
【子穴治证】${nazi["子穴治证"] || "暂无"} <!-- 同理精简 -->
【原穴治证】${nazi["原穴治证"] || "暂无"}
    `;
    // ========== 修改3：精简基础信息的换行 ==========
    let html = `
<span style="color: #d9534f; font-weight: bold;">【基础信息】</span>
操作类型：${zwlcActionType || "未知操作"}
北京时间：${result["原始北京时间"]}
真太阳时：${result["真太阳时"]}
当地经度：${result["当地经度"]}°E
日干支：${result["日干支"]} | 时干支：${result["时干支"]} | 时辰：${result["时辰"]}
${najiaHtml}
${naziHtml}
    `;
    resultEl.innerHTML = html;
}
 // ===================== 批量计算函数（核心扩展：补全治证/五行/经络字段） =====================
function batchCalculate(date, type, longitude, gender) {
    const batchDate = new Date(date);
    batchDate.setHours(0, 0, 0, 0);
    const results = [];
    
    // 遍历12时辰
    for (let i = 0; i < SHI_CHEN_FULL_CONFIG.length; i++) {
        const shiChen = SHI_CHEN_FULL_CONFIG[i][0];
        const shiMidHour = SHI_CHEN_FULL_CONFIG[i][3];
        const shiMidMinute = SHI_CHEN_FULL_CONFIG[i][4];
        
        // 构造当前时辰中点时间
        const shiTime = new Date(batchDate);
        shiTime.setHours(shiMidHour, shiMidMinute, 0, 0);
        
        let result = {
            序号: i + 1,
            时辰: shiChen,
            时辰时间段: `${SHI_CHEN_FULL_CONFIG[i][1]}:00-${SHI_CHEN_FULL_CONFIG[i][2]}:00`,
            时辰中点时间: formatTime(shiTime),
            当地经度: longitude + "°E"
        };
        
        if (type === "linggui") {
            // 灵龟八法批量计算（保持原有逻辑）
            const lgResult = LingGuiBaFaCore(shiTime, gender, longitude);
            result.日干支 = lgResult["日干支"] || "未知";
            result.时干支 = lgResult["时干支"] || "未知";
            result.主穴 = lgResult["主穴"] || "未知";
            result.配穴 = lgResult["配穴"] || "未知";
            result.组合治证 = lgResult["穴位组合主治"] || "暂无";
        } else if (type === "zwlc") {
            // 子午流注批量计算（核心扩展：提取五行/经络/治证字段）
            const zwResult = ZwLiuZhuCore(shiTime, longitude);
            const najia = zwResult["纳甲法结果"];
            const nazi = zwResult["纳子法结果"];

            // 基础信息
            result.日干支 = zwResult["日干支"] || "未知";
            result.时干支 = zwResult["时干支"] || "未知";

            // ========== 纳甲法字段扩展 ==========
            result.纳甲开穴 = najia["当前时辰纳甲开穴"] || "无专属开穴";
            result.纳甲合日互用 = najia["合日互用开穴"] || "无";
            result.纳甲经络属性 = najia["开穴经脉"] || "未知";
            // 提取五行属性（从穴位类型中解析，如"井穴(金)" → 金）
            const najiaWuXingMatch = najia["穴位类型"] ? najia["穴位类型"].match(/\((\w)\)/) : null;
            result.纳甲五行属性 = najiaWuXingMatch ? najiaWuXingMatch[1] : "未知";
            result.纳甲穴位治证 = najia["详细治证"] || "暂无";
            result.纳甲特殊说明 = najia["特殊说明"] || "无";

            // ========== 纳子法字段扩展 ==========
            result.纳子当令经脉 = nazi["当前时辰当令经脉"] || "未知";
            result.纳子当令经五行 = ZWLC_JINGMAI_WUXING[result.纳子当令经脉] || "未知";
            // 母穴信息
            result.纳子母穴 = nazi["当令经母穴"] || "未知";
            const muXueName = result.纳子母穴.split("(")[0] || "";
            result.纳子母穴经络 = GetXueWeiJingMai(muXueName) || "未知";
            result.纳子母穴治证 = nazi["母穴治证"] || "暂无";
            // 子穴信息
            result.纳子子穴 = nazi["当令经子穴"] || "未知";
            const ziXueName = result.纳子子穴.split("(")[0] || "";
            result.纳子子穴经络 = GetXueWeiJingMai(ziXueName) || "未知";
            result.纳子子穴治证 = nazi["子穴治证"] || "暂无";

            // ========== 原穴字段专项扩展 ==========
            result.纳子原穴 = nazi["当令经原穴"] || "未知";
            const yuanXueName = result.纳子原穴.split("(")[0] || "";
            result.纳子原穴经络 = GetXueWeiJingMai(yuanXueName) || "未知";
            // 原穴五行（取当令经五行）
            result.纳子原穴五行 = ZWLC_JINGMAI_WUXING[result.纳子当令经脉] || "未知";
            result.纳子原穴治证 = nazi["原穴治证"] || "暂无";
        }
        results.push(result);
    }
    
    // 生成扩展表格
    generateBatchTable(results, type);
}

// ===================== 批量表格渲染函数（核心升级：适配扩展字段） =====================
function generateBatchTable(results, type) {
    const tableEl = document.getElementById("batchTableResult");
    if (results.length === 0) {
        tableEl.innerHTML = "暂无批量计算结果";
        return;
    }

    // 灵龟八法表格（保持原有逻辑）
    if (type === "linggui") {
    // 新增：格式化日期为 YYYY-MM-DD（关键步骤）
    const batchDate = new Date(results[0].时辰中点时间); // 从结果中取日期
    const formattedDate = `${batchDate.getFullYear()}-${String(batchDate.getMonth() + 1).padStart(2, '0')}-${String(batchDate.getDate()).padStart(2, '0')}`;
    
    let tableHtml = `
    <div class="table-responsive">
        <!-- 下面修改标题行 -->
        <h5 class="text-center text-purple mb-3">灵龟八法 - ${formattedDate} ${results[0].日干支}日 全天12时辰开穴表</h5>
        <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark text-white">
                    <tr>
                        <th width="4%">时间段</th>
                        <th width="3%">时干支</th>
                        <th width="5%">主穴</th>
                        <th width="5%">配穴</th>
                        <th width="33%">组合治证</th>
                    </tr>
                </thead>
                <tbody>
        `;
        results.forEach(item => {
            tableHtml += `
                <tr>
                    <td>${item.时辰时间段}</td>
                    <td>${item.时干支}</td>
                    <td>${item.主穴}</td>
                    <td>${item.配穴}</td>
                    <td>${item.组合治证.replace(/\n/g, "<br/>")}</td>
                </tr>
            `;
        });
        tableHtml += `
                </tbody>
            </table>
        </div>
        `;
        tableEl.innerHTML = tableHtml;
        return;
    }

    // ========== 子午流注扩展表格渲染 ==========
    const batchDate = new Date(results[0].时辰中点时间); // 从结果中取日期
    const formattedDate = `${batchDate.getFullYear()}-${String(batchDate.getMonth() + 1).padStart(2, '0')}-${String(batchDate.getDate()).padStart(2, '0')}`;
   
    let tableHtml = `
    <div class="table-responsive">
        <h5 class="text-center text-orange mb-3">子午流注-${formattedDate} ${results[0].日干支}日 全天12时辰开穴详表</h5>
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-dark text-white">
                <tr>

                    <th rowspan="2" width="5%">时间段</th> <!-- 列宽从8%调至10%，更均衡 -->
                    <th rowspan="2" width="3%">时干支</th> <!-- 列宽从8%调至10%，更均衡 -->
                    <!-- 纳甲法表头 -->
                    <th colspan="4" class="text-center">纳甲法开穴信息</th>
                    <!-- 纳子法表头 -->
                    <th colspan="7" class="text-center">纳子法开穴信息</th>
                </tr>
                <tr>
                    <th width="6%">开穴</th>  <!-- 减1% -->
                    <th width="7%">合日互用</th>        <!-- 减1% -->
                    <th width="13%">穴位治证</th>       <!-- 减1% -->
                    <th width="6%">特殊说明</th>        <!-- 减1% -->
                    <th width="3%">经脉</th> <!-- 减1% -->
                    <th width="3%">母穴</th>            <!-- 减1% -->
                    <th width="15%">母穴治证</th>       <!-- 减1% -->
                    <th width="3%">子穴</th>            <!-- 减1% -->
                    <th width="15%">子穴治证</th>       <!-- 减1% -->
                    <th width="3%">原穴</th>            <!-- 减1% -->
                    <th width="18%">原穴治证</th>       <!-- 核心：调至20%，增加6%宽度 -->
                </tr>
            </thead>
            <tbody>
    `;

    // 表体数据填充
    results.forEach(item => {
        // 原穴详情合并：治证
        const yuanXueDetail = item.纳子原穴治证.replace(/\n/g, "<br/><br/>");
        
        tableHtml += `
            <tr>
                <td>${item.时辰时间段}</td>
                <td>${item.时干支}</td>
                <!-- 纳甲法列：开穴 + (经络属性) -->
                <td>${item.纳甲开穴}(${item.纳甲经络属性})</td>
                <td>${item.纳甲合日互用}</td>
                <td>${item.纳甲穴位治证.replace(/\n/g, "<br/><br/>")}</td>
                <td>${item.纳甲特殊说明}</td>
                <!-- 纳子法列：当令经脉 + (当令经五行) -->
                <td>${item.纳子当令经脉}(${item.纳子当令经五行})</td>
                <td>${item.纳子母穴}</td>
                <td>${item.纳子母穴治证.replace(/\n/g, "<br/><br/>")}</td>
                <td>${item.纳子子穴}</td>
                <td>${item.纳子子穴治证.replace(/\n/g, "<br/><br/>")}</td>
                <td>${item.纳子原穴}</td>
                <td>${yuanXueDetail}</td>
            </tr>
        `;
    });

    tableHtml += `
            </tbody>
        </table>
    </div>
    `;
    tableEl.innerHTML = tableHtml;
}
        // ===================== 按钮事件绑定 =====================
        function bindButtonEvents() {
            // 灵龟八法按钮
// 灵龟八法「当前时间开穴」按钮
document.getElementById("lgCurrentBtn").addEventListener("click", function() {
    const now = new Date();
    const gender = document.querySelector('input[name="gender"]:checked').value;
    const longitude = parseFloat(document.getElementById("longitude").value) || 120.0;
    // 记录动作类型
    lingguiActionType = "当前时间开穴";
    const result = LingGuiBaFaCore(now, gender, longitude);
    showLingGuiResult(result);
});

            // 灵龟八法「自定义时间开穴」按钮
            document.getElementById("lgCustomBtn").addEventListener("click", function() {
                const customTimeStr = document.getElementById("customDatetime").value;
                if (!customTimeStr) {
                    alert("请选择自定义时间！");
                    return;
                }
                const customTime = new Date(customTimeStr);
                const gender = document.querySelector('input[name="gender"]:checked').value;
                const longitude = parseFloat(document.getElementById("longitude").value) || 120.0;
                // 记录动作类型
                lingguiActionType = "自定义时间开穴";
                const result = LingGuiBaFaCore(customTime, gender, longitude);
                showLingGuiResult(result);
            });

            // 灵龟八法「清空结果」按钮（新增：清空动作类型）
            document.getElementById("lgClearBtn").addEventListener("click", function() {
                document.getElementById("lingguiResult").innerHTML = "请点击上方功能按钮进行计算...";
                lingguiActionType = ""; // 清空记录
            });

            document.getElementById("lgBatchBtn").addEventListener("click", function() {
                const batchDateStr = document.getElementById("batchDate").value;
                if (!batchDateStr) {
                    alert("请选择批量计算日期！");
                    return;
                }
                const gender = document.querySelector('input[name="gender"]:checked').value;
                const longitude = parseFloat(document.getElementById("longitude").value) || 120.0;
                batchCalculate(batchDateStr, "linggui", longitude, gender);
            });

            document.getElementById("lgClearBtn").addEventListener("click", function() {
                document.getElementById("lingguiResult").innerHTML = "请点击上方功能按钮进行计算...";
            });

// 子午流注「当前时间开穴」按钮
document.getElementById("zwCurrentBtn").addEventListener("click", function() {
    const now = new Date();
    const longitude = parseFloat(document.getElementById("longitude").value) || 120.0;
    // 记录动作类型
    zwlcActionType = "当前时间开穴";
    const result = ZwLiuZhuCore(now, longitude);
    showZwlcResult(result);
});

            // 子午流注「自定义时间开穴」按钮
            document.getElementById("zwCustomBtn").addEventListener("click", function() {
                const customTimeStr = document.getElementById("customDatetime").value;
                if (!customTimeStr) {
                    alert("请选择自定义时间！");
                    return;
                }
                const customTime = new Date(customTimeStr);
                const longitude = parseFloat(document.getElementById("longitude").value) || 120.0;
                // 记录动作类型
                zwlcActionType = "自定义时间开穴";
                const result = ZwLiuZhuCore(customTime, longitude);
                showZwlcResult(result);
            });

            // 子午流注「清空结果」按钮（新增：清空动作类型）
            document.getElementById("zwClearBtn").addEventListener("click", function() {
                document.getElementById("zwlcResult").innerHTML = "请点击上方功能按钮进行计算...";
                zwlcActionType = ""; // 清空记录
            });

            document.getElementById("zwBatchBtn").addEventListener("click", function() {
                const batchDateStr = document.getElementById("batchDate").value;
                if (!batchDateStr) {
                    alert("请选择批量计算日期！");
                    return;
                }
                const longitude = parseFloat(document.getElementById("longitude").value) || 120.0;
                batchCalculate(batchDateStr, "zwlc", longitude);
            });

            document.getElementById("zwClearBtn").addEventListener("click", function() {
                document.getElementById("zwlcResult").innerHTML = "请点击上方功能按钮进行计算...";
            });

            // 按钮激活样式
            const lgButtons = document.querySelectorAll('.btn-outline-purple');
            lgButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    lgButtons.forEach(b => b.classList.remove('btn-active'));
                    this.classList.add('btn-active');
                });
            });

            const zwButtons = document.querySelectorAll('.btn-outline-orange');
            zwButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    zwButtons.forEach(b => b.classList.remove('btn-active'));
                    this.classList.add('btn-active');
                });
            });
        }
    </script>
</body>
</html>               